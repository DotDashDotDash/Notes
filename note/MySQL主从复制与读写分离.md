# MySQL主从复制与读写分离

## MySQL主从复制是为了什么

在实际的情况下，面对高并发的业务场景，经常出现不止在一台服务器上部署MySQL，而要在不同的服务器上部署MySQL作为一个整体的数据库，则会面对数据不一致的情况，主从复制就是为了解决MySQL服务器数据不一致的情况

## 主从复制的流程

* Master数据库将操作写进二进制文件中(配置文件的`/log`文件夹)
* Slave数据库通过I/O线程将Master的二进制日志文件写进自己的**中继文件**中
* SQL线程重放中继文件中MasterSQL的操作

## 主从复制的注意事项

* Master和Slave操作系统的位数要一致
* Master和Slave数据库的版本要一致
* Master和Slave配置文件中的`server_id`要不同

## MySQL读写分离

### 读写分离的业务场景

因为用户的增多，数据的增多，单机的数据库往往支撑不住快速发展的业务，所以数据库集群就产生了！今天来说说读写分离的数据库集群方式！ 读写分离顾名思义就是读和写分离了，对应到数据库集群一般都是一主一从(一个主库，一个从库)或者一主多从(一个主库，多个从库)，业务服务器把需要写的操作都写到主数据库中，读的操作都去从库查询。主库会同步数据到从库保证数据的一致性。 

**这种集群方式的本质就是把访问的压力从主库转移到从库**，也就是在单机数据库无法支撑并发读写的时候，并且读的请求很多的情况下适合这种读写分离的数据库集群。如果写的操作很多的话不适合这种集群方式，因为你的数据库压力还是在写操作上，即使主从了之后压力还是在主库上和单机区别就不大了。

在单机的情况下，一般我们做数据库优化都会加索引，但是加了索引对查询有优化，但是会影响写入，因为写入数据会更新索引。**所以做了主从之后，我们可以单独的针对从库(读库)做索引上的优化，而主库(写库)可以减少索引而提高写的效率**

### 读写分离之后可能会面临的问题

因为所有的写操作都经过主服务器，而读操作一般由从服务器完成，那么就会出现下面的情况:

```markdown
场景:
一个用户下了订单支付并支付
支付的操作由主服务器完成但是没有写入到从服务器
用户刷新支付界面
此时请求从服务器的读操作
从服务器显示用户没有支付完成
```

这就是由主从延迟造成的数据不一致操作，解决上述问题可以用下面的方法:

1. **每次写操作之后的读操作都经过主服务器**
2. **写操作完成之后读取从服务器，如果从服务器没有结果请求一次主服务器，这被称为“二次请求”**
3. **对延迟要求高的业务由主库完成，由延迟要求低的业务由从服务器完成**
